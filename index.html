<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MQTT Chatroom</title>

    <link rel="stylesheet" href="style.css">

    <!-- MQTT Library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <!-- App Scripts -->
    <script defer src="themes.js"></script>
    <script defer src="emoji.js"></script>
    <script defer src="admin.js"></script>
    <script defer src="app.js"></script>

    <style>
        /* Debug Console */
        #debugConsole {
            position: fixed;
            bottom: -300px;
            left: 0;
            width: 100%;
            height: 300px;
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            overflow-y: auto;
            border-top: 2px solid #0f0;
            transition: bottom 0.3s ease;
            z-index: 9999;
            white-space: pre-wrap;
        }
        #debugConsole.open {
            bottom: 0;
        }
    </style>
</head>
<body>

<!-- Debug Console -->
<div id="debugConsole"></div>

<script>
    // Debug Console Logic
    const dbg = document.getElementById("debugConsole");

    function logToConsole(msg) {
        dbg.textContent += msg + "\n";
        dbg.scrollTop = dbg.scrollHeight;
    }

    // Override console.log
    console.log = (...args) => {
        logToConsole("[LOG] " + args.join(" "));
    };

    // Capture errors
    window.onerror = function(msg, src, line, col, err) {
        logToConsole("[ERROR] " + msg + " @ " + src + ":" + line);
    };

    // Toggle console with "~"
    document.addEventListener("keydown", e => {
        if (e.key === "`" || e.key === "~") {
            dbg.classList.toggle("open");
        }
    });

    console.log("Debug console initialized.");
</script>

<!-- Login Panel -->
<div id="login" class="panel">
    <h2>Enter Password</h2>
    <p class="hint">
        Use your access password.<br>
        Prefix with <b>*67</b> to hide your name.<br>
        Use <b>*#0*#</b> for the About menu.
    </p>
    <input id="pw" type="password" placeholder="Password">
    <button id="loginBtn">Enter</button>
</div>

<!-- About Menu -->
<div id="aboutMenu" class="panel" style="display:none;">
    <h2>About This Site</h2>
    <p><b>Version:</b> 2.0.0</p>
    <p><b>Creator:</b> Chris & XGFZTeam</p>
    <button onclick="location.reload()">Back</button>
</div>

<!-- Chat UI -->
<div id="chat" style="display:none;">
    <div id="chatContainer">

        <!-- Sidebar -->
        <aside id="sidebar">
            <h3>Chat Info</h3>
            <div id="userInfo">
                <div><b>You:</b> <span id="currentUserLabel"></span></div>
                <div class="subinfo">
                    Broker: flespi<br>
                    Topic: ttg/chat/main
                </div>
            </div>

            <h3>Online</h3>
            <div id="userList"></div>

            <h3>Rooms</h3>
            <div id="roomList"></div>

            <button id="themeToggle">Toggle Theme</button>
            <button id="adminBtn">Admin Panel</button>
        </aside>

        <!-- Main Chat -->
        <main id="mainChat">
            <header id="chatHeader">
                <h2 id="roomTitle">MQTT Chatroom</h2>
                <span class="subinfo">Secure Room</span>
            </header>

            <div id="chatBox"></div>
            <div id="typingIndicator"></div>

            <div id="inputRow">
                <button id="emojiBtn">ðŸ˜Š</button>
                <input id="msg" placeholder="Type a message">
                <button id="sendBtn">Send</button>
            </div>
        </main>
    </div>
</div>

<!-- Emoji Picker -->
<div id="emojiPicker" style="display:none;"></div>

<!-- Admin Panel -->
<div id="adminPanel" style="display:none;">
    <div class="adminContent">
        <h2>Admin Panel</h2>
        <button id="kickBtn">Kick User</button>
        <button id="muteBtn">Mute User</button>
        <button id="announceBtn">Send Announcement</button>
        <button onclick="document.getElementById('adminPanel').style.display='none'">Close</button>
    </div>
</div>

</body>
</html>
